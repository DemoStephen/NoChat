<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Page</title>
    <link rel="stylesheet" href="/static/chat-page.css">
</head>
<body>
  <h1>You (<%= user1 %>) are now chatting with <%= user2 %>!</h1>
  <p>Please reload the page after you send a message *(We're working on fixing that ;>)</p>

  <!-- Add data attributes to store user values -->
  <div id="userData" data-user1="<%= user1 %>" data-user2="<%= user2 %>"></div>
  <% if (chat && chat.length > 0) { %>
    <ul id="chatList">
      <% chat.forEach(line => { %>
        <% if (line.split(':')[0] === user1) { %>
          <li class="user"><%= line %> </li>
        <% } else { %>
          <li class="other"><%= line %> </li>
        <% } %>
      <% }) %>
    </ul>
    <% } else { %>
      <p>No one has started a conversation yet</p>
    <% } %>

  <div class="chatContainer">
    <input id="message" placeholder="Type a message..." name="message"></input>
    <button id="sendButton">Send</button>
  </div>
  <!--<a href="/chat/<%= user1 %>" class="button-link">Chat</a>-->


  <script>
    const userDataElement = document.getElementById('userData');
    const user1 = userDataElement.getAttribute('data-user1');
    const user2 = userDataElement.getAttribute('data-user2');
    console.log('User1:', user1);
    console.log('User2:', user2);
    // Function to send message
    async function sendMessage() {
      const message = document.getElementById('message').value.trim();

      if (message === '') {
        alert('Please type a message.');
        return;
      }

      try {
        const response = await fetch(`/chat-send/${user2}`, {
          method: 'POST',
          credentials: 'include', // Include cookies with the request
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: `${user1}: ${message}` }),
        });

        if (response.ok) {
          const data = await response.json();

          // Clear the input field
          document.getElementById('message').value = '';  // Fix clearing the input field

          // Append new message to chat list
          const chatList = document.getElementById('chatList');
          const newMessage = document.createElement('li');
          newMessage.textContent = `You: ${data.message}`;
          chatList.appendChild(newMessage);

        } else {
          console.error('Failed to send message:', response.statusText);
        }
        console.log(response);

      } catch (err) {
        console.log('Error occurred:', err.message);
      }
    }

    // Add event listener to Send button
    document.querySelector('#sendButton').addEventListener('click', sendMessage);

    // Add event listener to the Enter key
    document.getElementById('message').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    // Scrol the entire page's content to the bottom immediately
    window.onload = function() {
      const chatList = document.getElementById('chatList');
      chatList.scrollTop = chatList.scrollHeight;
    };

  </script>
</body>
</html>
